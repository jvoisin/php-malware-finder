FROM ubuntu:20.04 as build
ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

# install build dependencies
RUN apt-get update \
    && apt-get install -y \
    build-essential \
    autoconf \
    libtool \
    pkg-config \
    bison \
    libssl-dev \
    libprotobuf-c-dev \
    git \
    wget \
    && rm -rf /var/lib/apt/lists/*

# install Go
ARG GO_VERSION='1.18'
ADD https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz /tmp
RUN tar -C /usr/local -xzf /tmp/go${GO_VERSION}.linux-amd64.tar.gz
ENV PATH=${PATH}:/usr/local/go/bin

# install YARA
RUN git clone --depth 1 https://github.com/virustotal/yara.git \
    && cd yara \
    && bash ./build.sh \
    && make install \
    && cd ..

# copy and build PMF
ENV LD_LIBRARY_PATH=/usr/local/lib
COPY . .
RUN make

FROM ubuntu:20.04
ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

# install dependencies
RUN apt-get update \
    && apt-get install -y \
    libssl1.1 \
    libprotobuf-c1 \
    && rm -rf /var/lib/apt/lists/*

# copy files from build container
COPY --from=build /usr/local/lib /usr/lib
COPY --from=build /app/php-malware-finder /app

ENTRYPOINT ["/app/php-malware-finder", "-v", "-a", "-c", "/data"]
