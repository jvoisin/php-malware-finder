.PHONY: clean rebuild update-deps tests help

TAG_COMMIT := $(shell git rev-list --abbrev-commit --all --max-count=1)
VERSION := $(shell git describe --abbrev=0 --tags --exact-match $(TAG_COMMIT) 2>/dev/null || true)
DATE := $(shell git log -1 --format=%cd --date=format:"%Y%m%d%H%M")
ifeq ($(VERSION),)
    VERSION := $(DATE)
endif
LDFLAGS := "-X main.version=$(VERSION)"
GO_FLAGS := -ldflags $(LDFLAGS)

all: php-malware-finder

php-malware-finder: ## Build application
	@go build $(GO_FLAGS) .

clean: ## Delete build artifacts
	@rm -f php-malware-finder

rebuild: clean all ## Delete build artifacts and rebuild

update-deps: ## Update dependencies
	@go get -u .
	@go mod tidy -v

tests: php-malware-finder
	@bash ./tests.sh

help: ## Show this help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'
