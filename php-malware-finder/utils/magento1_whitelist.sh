#!/bin/bash
# Quit script if something goes wrong
set  -o errexit  -o nounset  -o pipefail;

SCRIPTDIR="$(dirname "$(readlink -f $0)")";
OUTFILE="${SCRIPTDIR}/../whitelists/magento1ce.yar";
TMPFILE="${OUTFILE}.new";

# First empty the target whitelist so we can completely generate a new one
cat <<EOF >"${OUTFILE}";
private rule Magento1Ce
{
	condition:
		false
}
EOF

# Create a temporary directory and make sure it is empty
TEMPDIR="$TEMP/gen_whitelist";
rm -rf "${TEMPDIR}";
mkdir "${TEMPDIR}";

# Header
cat <<EOF | tee "${TMPFILE}";
private rule Magento1Ce
{
	condition:
EOF

TAGS=$( git ls-remote --tags https://github.com/OpenMage/magento-mirror.git | cut -d '/' -f3 | grep -P '^[\d\.]+$' );
while read -r TAG; do
    wget "https://github.com/OpenMage/magento-mirror/archive/${TAG}.tar.gz" -O "${TEMPDIR}/${TAG}.tgz";
    tar -C "${TEMPDIR}" -xpzf "${TEMPDIR}/${TAG}.tgz";
    echo "		/* Magento CE ${TAG} */" | tee -a "${TMPFILE}";
    ${SCRIPTDIR}/generate_whitelist.py "Magento CE ${TAG}" "${TEMPDIR}/magento-mirror-${TAG}" | grep 'hash.sha1' | sed "s|// ${TEMPDIR}/magento-mirror-${TAG}/|// |" | tee -a "${TMPFILE}";
    echo "		" | tee -a "${TMPFILE}";
done <<< "${TAGS}";

# Footer
cat <<EOF | tee -a "${TMPFILE}";
		false
}
EOF

# Copy temporary file to target whitelist while removing duplicate lines except empty ones
cat "${TMPFILE}" | awk 'match($0,/^\s*$/)||!seen[$0]++' > "${OUTFILE}";

# Clean up
rm "${TMPFILE}";
rm -rf "${TEMPDIR}";
